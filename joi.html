<!DOCTYPE html>
<html lang="en">
  <head>
    

    <!-- <link rel="stylesheet" href="css/bootstrap-grid.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css" crossorigin="anonymous">
    <script src="js/bootstrap.min.js" crossorigin="anonymous"></script> -->

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>


    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AJAX solicitud API</title>
  </head>
  <body>
    <main>

      <div class="container">
        <div class="row">
          <div class="col">
            <div>
              <label for="number">Escoge un numero:</label><br/>
              <input id="number" type="number" min="1" max="671" /><br/>  
      
              <div>
                <figure>
                  <p></p>
                  <img id="avatar" src="" alt="" />
                </figure>
              </div>
            </div>
          </div>
          <div class="col">

            <table class="table">
              <thead>
                <th>Description</th>
              </thead>
              <tbody>
                <tr>
                  <th>Name: </th>
                  <td><figcaption id="imageDescription"></figcaption></td>
                </tr>
                <tr>
                  <th>Status: </th>
                  <td><figcaption id="statusDes"></figcaption></td>
                </tr>
                <tr>
                  <th>Species: </th>
                  <td><figcaption id="personajeSpecie"></figcaption></td>
                </tr>
                <tr>
                  <th>Gender: </th>
                  <td><figcaption id="personajeGenders"></figcaption></td>
                </tr>
                <tr>
                  <th>Origin: </th>
                  <td><figcaption id="personajeOrigins"></figcaption></td>
                </tr>
                <tr>
                  <th>Location: </th>
                  <td><figcaption id="personajeLocations"></figcaption></td>
                </tr>
              </tbody>
            </table>

          </div>

          <table class='table'>
            <thead>
              <th>Episodios</th>
              <th>Nombre</th>
              <th>Fecha</th>
            </thead>
            <tbody id="parsed_csv_list">

            </tbody>
          </table>
          <!-- </div>
            <div class="row" <div="" id="parsed_csv_list">

            </div>
          </div> -->



        </div>
      </div>

      


    </main>
  </body>
</html>

<script>
'use strict'

// ------ SAVING IN CONSTANTS THE DOM ELEMENTS WE NEED TO WORK WITH ------ //

// the inputValue allows us to access the value of the user's input, i.e. the chosen number
const inputValue = document.getElementById('number')

// this constant allows us to set the image to be displayed, by dynamically changing its "src" attribute
const avatar = document.getElementById('avatar')

// here we create a link to the image description element, so we can change the displayed character name
const imageDescription = document.getElementById('imageDescription')

// ------ SAVING THE URL OF THE API WE WANT TO REQUEST DATA FROM ------ //
const API_URL = 'https://rickandmortyapi.com/api/character/:id'

var request = new XMLHttpRequest()
var tabla = "";

function getCharacter (id) {
  const URL = API_URL.replace(':id', id)
  request.open('GET', URL)
  request.setRequestHeader('X-Requested-With', 'XMLHttpRequest')
  request.responseType = 'json'
  request.onload = function () {
    // the response status tells us the HTTP status code, if it is 200, it means the response status is "OK"
    if (this.status === 200) {
      // we save the response into a variable
      var newCharacterJSON = this.response
      //console.log(newCharacterJSON)

      // upon studying the response data structure, we know we need to access the "image" JSON key to get the image URL
      var imagePath = newCharacterJSON.image

      // now we set the src attribute of our image element to the URL from the reponse
      avatar.setAttribute('src', imagePath)

      // to get the image description, we access the "name" JSON key
      var characterName = newCharacterJSON.name
      var personajeStatus = newCharacterJSON.status
      var personajeSpecies = newCharacterJSON.species
      var personajeGender = newCharacterJSON.gender
      var personajeOrigin = newCharacterJSON.origin.name
      var personajeLocation = newCharacterJSON.location.name

      var episodio = new Array; 

      console.log(newCharacterJSON);

      newCharacterJSON.episode.forEach(element => {
        episodio.push(element)
        ep(element)
      });
      
      //console.log(tabla)

      if (characterName) {
      // we set the text to show the name we got from the response
        imageDescription.innerHTML = characterName
        statusDes.innerHTML = personajeStatus
        personajeSpecie.innerHTML= personajeSpecies
        personajeGenders.innerHTML = personajeGender
        personajeOrigins.innerHTML = personajeOrigin
        personajeLocations.innerHTML = personajeLocation
        //$("#parsed_csv_list").html(tabla);

        limpia()
      } else {
        // if no input has been given, we display the message to choose one
        imageDescription.innerHTML = 'Please choose a number'
      }

      
      


    } else {
      // if the response status is different from 200, an error ocurred (the ID may be out of range)
      imageDescription.innerHTML =
        `An error occurred during your request! Choose a different number. Code: ${request.status}`
    }
  }
  request.send()
}

function ep(URL){
  let request2 = new XMLHttpRequest()

  //console.log(URL)
  request2.open('GET', URL)
  request2.setRequestHeader('X-Requested-With', 'XMLHttpRequest')
  request2.responseType = 'json'
  //console.log(request)
  request2.onload = function () {
    //console.log('funcion')
    if (this.status === 200) {
      //console.log('if')
      var episodioJSON = this.response

     // console.log(episodioJSON);
      //console.log('<tr> <th>Episodio: </th> <td> '+episodioJSON.name +' </td> <td> '+episodioJSON.air_date+' </td>  </tr>')
      
      tabla+='<tr> <th>Episodio: </th> <td> '+episodioJSON.name +' </td> <td> '+episodioJSON.air_date+' </td>  </tr>';
      parsed_csv_list.innerHTML = tabla
      //console.log(episodioJSON)
    } 
    else 
    {
      // if no input has been given, we display the message to choose one
      imageDescription.innerHTML = 'Please choose a number'
    }

  }
  request2.send()

}

function limpia(){
  tabla = "";
}

inputValue.addEventListener('change', function () {
  const choosenNumber = inputValue.value
  getCharacter(choosenNumber)
})

</script>
